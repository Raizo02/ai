import React, { useState, useEffect, useRef } from 'react';
import { Play, Square, ArrowLeft, Activity, Trophy, Clock, ChevronRight, Camera, AlertCircle } from 'lucide-react';

// --- Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-gray-900 border border-gray-800 rounded-xl overflow-hidden ${className}`}>
    {children}
  </div>
);

const Button = ({ onClick, children, variant = "primary", className = "", icon: Icon, disabled = false }) => {
  const baseStyle = "flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/50",
    secondary: "bg-gray-800 hover:bg-gray-700 text-gray-200 border border-gray-700",
    danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/50",
    outline: "bg-transparent border border-gray-600 text-gray-400 hover:text-white hover:border-gray-400"
  };

  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {Icon && <Icon size={20} />}
      {children}
    </button>
  );
};

// --- Main App Component ---

export default function ArmyFitAI() {
  const [view, setView] = useState('home'); // home, workout
  const [activeType, setActiveType] = useState(null); // pushup, situp, run
  const [history, setHistory] = useState([]);
  
  // Workout State
  const [isActive, setIsActive] = useState(false);
  const [duration, setDuration] = useState(0);
  const [reps, setReps] = useState(0);
  const [bodyAngle, setBodyAngle] = useState(0);
  const [postureState, setPostureState] = useState('UP');
  const [cameraError, setCameraError] = useState(null);
  
  // Refs
  const timerRef = useRef(null);
  const simulationRef = useRef(null);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  // Format time (MM:SS)
  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Start Workout & Camera
  const startWorkout = async (type) => {
    setActiveType(type);
    setView('workout');
    setIsActive(false);
    setDuration(0);
    setReps(0);
    setBodyAngle(0);
    setPostureState('UP');
    setCameraError(null);

    // Initialize Camera
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }, 
        audio: false 
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
      }
    } catch (err) {
      console.error("Camera Error:", err);
      setCameraError("Camera access denied or unavailable.");
    }
  };

  // Cleanup Camera
  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
  };

  // Toggle Timer & Simulation
  const toggleSession = () => {
    if (isActive) {
      // Pause
      clearInterval(timerRef.current);
      clearInterval(simulationRef.current);
      setIsActive(false);
    } else {
      // Start
      setIsActive(true);
      
      // Main Timer
      timerRef.current = setInterval(() => {
        setDuration(prev => prev + 1);
      }, 1000);

      // Simulate AI Stats (Since we don't have TensorFlow.js loaded)
      if (activeType !== 'run') {
        simulationRef.current = setInterval(() => {
          // Randomize angle to simulate detection
          const baseAngle = activeType === 'pushup' ? 15 : 45;
          const noise = Math.floor(Math.random() * 10) - 5;
          setBodyAngle(baseAngle + noise);
          
          // Randomly flip state
          if (Math.random() > 0.8) {
            setPostureState(prev => prev === 'UP' ? 'DOWN' : 'UP');
          }
        }, 800);
      }
    }
  };

  // Manual Rep Add
  const addRep = () => {
    setReps(prev => prev + 1);
    setPostureState('UP');
  };

  // Stop & Save
  const stopAndSave = () => {
    clearInterval(timerRef.current);
    clearInterval(simulationRef.current);
    stopCamera();
    
    const newRecord = {
      id: Date.now(),
      type: activeType,
      date: new Date().toLocaleDateString(),
      reps: activeType === 'run' ? null : reps,
      duration: duration,
      distance: activeType === 'run' ? (duration * 0.003).toFixed(2) : null
    };
    
    setHistory([newRecord, ...history]);
    setIsActive(false);
    setView('home');
  };

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      clearInterval(timerRef.current);
      clearInterval(simulationRef.current);
      stopCamera();
    };
  }, []);

  // Ensure video element gets stream if view changes/ref attaches
  useEffect(() => {
    if (view === 'workout' && streamRef.current && videoRef.current) {
      videoRef.current.srcObject = streamRef.current;
    }
  }, [view]);

  // --- Views ---

  const HomeView = () => (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="text-center space-y-4 py-8">
        <div className="inline-flex items-center justify-center p-4 bg-emerald-500/10 rounded-full mb-4 ring-1 ring-emerald-500/50">
          <Activity size={48} className="text-emerald-500" />
        </div>
        <h1 className="text-4xl md:text-5xl font-black tracking-tight text-white">
          ARMY FIT <span className="text-emerald-500">AI</span>
        </h1>
        <p className="text-gray-400 text-lg max-w-md mx-auto">
          Military-grade fitness tracking. Now with real camera support.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
        {['pushup', 'situp', 'run'].map(type => (
          <button 
            key={type}
            onClick={() => startWorkout(type)}
            className="group relative overflow-hidden bg-gray-800 hover:bg-gray-700 p-6 rounded-2xl border border-gray-700 transition-all hover:-translate-y-1 hover:border-emerald-500/50 text-left"
          >
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <Activity size={64} />
            </div>
            <h3 className="text-xl font-bold text-white mb-2 capitalize">{type === 'run' ? 'Run 2.4km' : type + 's'}</h3>
            <p className="text-sm text-gray-400">
              {type === 'run' ? 'Cardio Test' : 'Strength Test'}
            </p>
          </button>
        ))}
      </div>

      <div className="max-w-2xl mx-auto pt-8">
        <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
          <Clock size={20} className="text-emerald-500" />
          Recent Workouts
        </h2>
        {history.length === 0 ? (
          <div className="text-center py-12 bg-gray-900/50 rounded-xl border border-dashed border-gray-800">
            <Trophy className="mx-auto text-gray-700 mb-3" size={32} />
            <p className="text-gray-500">No workouts recorded yet.</p>
          </div>
        ) : (
          <div className="space-y-3">
            {history.map((item) => (
              <div key={item.id} className="bg-gray-900/80 border border-gray-800 p-4 rounded-xl flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className={`p-2 rounded-lg ${
                    item.type === 'run' ? 'bg-blue-500/10 text-blue-500' : 'bg-emerald-500/10 text-emerald-500'
                  }`}>
                    {item.type === 'run' ? <Activity size={20} /> : <Trophy size={20} />}
                  </div>
                  <div>
                    <h4 className="text-white font-semibold capitalize">{item.type} Session</h4>
                    <p className="text-xs text-gray-500">{item.date}</p>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-emerald-400 font-mono font-bold">
                    {item.type === 'run' ? `${item.distance} km` : `${item.reps} reps`}
                  </div>
                  <div className="text-xs text-gray-500">{formatTime(item.duration)}</div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  const WorkoutView = () => (
    <div className="h-full flex flex-col max-w-lg mx-auto animate-in zoom-in-95 duration-300">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-2 text-emerald-500 font-bold uppercase tracking-wider">
          <Activity size={18} />
          {activeType} Mode
        </div>
        <div className={`px-3 py-1 rounded-full text-xs font-mono border ${isActive ? 'bg-red-500/20 text-red-400 border-red-500/50' : 'bg-gray-800 text-gray-400 border-gray-700'}`}>
          {isActive ? '● LIVE' : 'STANDBY'}
        </div>
      </div>

      <div className="relative aspect-[4/5] bg-gray-900 rounded-3xl overflow-hidden border-2 border-gray-800 shadow-2xl mb-6 group">
        
        {/* Real Camera View */}
        {cameraError ? (
          <div className="absolute inset-0 flex flex-col items-center justify-center text-red-400 p-6 text-center">
            <AlertCircle size={48} className="mb-4" />
            <p className="font-bold">{cameraError}</p>
            <p className="text-sm mt-2 text-gray-500">Please allow camera access to use this feature.</p>
          </div>
        ) : (
          <video 
            ref={videoRef}
            autoPlay 
            playsInline 
            muted
            className={`absolute inset-0 w-full h-full object-cover ${!isActive ? 'grayscale opacity-50' : ''}`} 
          />
        )}

        {/* Overlay Elements */}
        {!isActive && !cameraError && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/40 z-10">
            <div className="text-white font-bold bg-black/50 px-4 py-2 rounded-full backdrop-blur-sm">
              PRESS START
            </div>
          </div>
        )}

        {/* Data Overlay */}
        <div className="absolute inset-0 p-6 flex flex-col justify-between z-20 pointer-events-none">
          <div className="flex justify-between items-start">
            <div className="bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-lg border border-white/10">
              <span className="text-xs text-gray-400 uppercase mr-2">Status</span>
              <span className={`font-bold ${isActive ? 'text-green-400' : 'text-yellow-400'}`}>
                {isActive ? 'TRACKING' : 'PAUSED'}
              </span>
            </div>
            {activeType !== 'run' && (
              <div className="bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-lg border border-white/10 text-right">
                <div className="text-xs text-gray-400 uppercase">Angle</div>
                <div className="font-mono text-white">{isActive ? bodyAngle : 0}°</div>
              </div>
            )}
          </div>

          <div className="space-y-4">
            <div className="text-center">
              <div className="text-7xl font-black text-white drop-shadow-lg tracking-tighter">
                {activeType === 'run' ? formatTime(duration) : reps}
              </div>
              <div className="text-emerald-400 font-bold uppercase tracking-widest text-sm mt-1 drop-shadow-md">
                {activeType === 'run' ? 'DURATION' : 'REPETITIONS'}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              {activeType === 'run' ? (
                <>
                  <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10">
                     <div className="text-xs text-gray-400">Est. Distance</div>
                     <div className="text-xl font-mono text-white">{(duration * 0.003).toFixed(2)} <span className="text-xs">km</span></div>
                  </div>
                  <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10">
                     <div className="text-xs text-gray-400">Pace</div>
                     <div className="text-xl font-mono text-white">5:30 <span className="text-xs">/km</span></div>
                  </div>
                </>
              ) : (
                <>
                  <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10">
                     <div className="text-xs text-gray-400">Position</div>
                     <div className={`text-xl font-bold ${postureState === 'UP' ? 'text-blue-400' : 'text-orange-400'}`}>
                       {postureState}
                     </div>
                  </div>
                  <div className="bg-black/60 backdrop-blur-md p-3 rounded-xl border border-white/10">
                     <div className="text-xs text-gray-400">Time</div>
                     <div className="text-xl font-mono text-white">{formatTime(duration)}</div>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Controls */}
      <div className="space-y-3 pointer-events-auto">
        {!isActive ? (
          <Button onClick={toggleSession} icon={Play} className="w-full text-lg shadow-emerald-500/20">
            START TRACKING
          </Button>
        ) : (
          <div className="grid grid-cols-2 gap-3">
             <Button onClick={toggleSession} variant="secondary" className="w-full">
               PAUSE
             </Button>
             <Button onClick={stopAndSave} variant="danger" icon={Square} className="w-full">
               STOP & SAVE
             </Button>
             {activeType !== 'run' && (
               <button 
                onClick={addRep}
                className="col-span-2 py-4 border-2 border-dashed border-gray-700 rounded-lg text-gray-500 hover:text-white hover:border-emerald-500 hover:bg-emerald-500/10 transition-colors text-sm font-semibold uppercase tracking-wider"
               >
                 + Manual Rep Override
               </button>
             )}
          </div>
        )}
        
        {!isActive && (
          <Button onClick={() => { stopCamera(); setView('home'); }} variant="outline" icon={ArrowLeft} className="w-full">
            Back to Dashboard
          </Button>
        )}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-black text-gray-100 font-sans selection:bg-emerald-500/30">
      <div className="max-w-md mx-auto min-h-screen flex flex-col p-4">
        {view === 'home' ? <HomeView /> : <WorkoutView />}
      </div>
    </div>
  );
}
